const DATA_URL='data.json';const STORAGE_KEY='ged_trainer_a3b1_v1';let words={};let list=[];function showBottom(msg){const el=document.getElementById('bottomHint');el.innerText=msg;el.style.display='block';setTimeout(()=>el.style.display='none',2500);}async function load(){try{const r=await fetch(DATA_URL);words=await r.json();list=Object.keys(words).map(k=>({en:k,...words[k]}));saveLocalIfMissing();renderList(list.slice(0,200));}catch(e){showBottom('加载词库失败');}}function saveLocalIfMissing(){if(!localStorage.getItem(STORAGE_KEY)){localStorage.setItem(STORAGE_KEY,JSON.stringify(list));}}function renderList(arr){const el=document.getElementById('wordList');if(!arr||arr.length===0)return el.innerHTML='<div class="small">无匹配词条</div>';el.innerHTML=arr.map(w=>`<div class="word-row"><div><strong>${escapeHtml(w.cn||'')}</strong> <span class="small">— ${escapeHtml(w.en||'')}</span><div class="small" style="color:#9aa4b2;margin-top:6px">例：${escapeHtml(w.example_en)}<br/>中：${escapeHtml(w.example_cn)}</div></div><div class="small">${w.correct||0}✓ ${w.wrong||0}✗</div></div>`).join('');}function escapeHtml(s){return(s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}document.getElementById('btnShowAll').onclick=()=>renderList(list);document.getElementById('btnExport').onclick=()=>{const rows=list.map(w=>`"${(w.cn||'').replace(/"/g,'""')}","${(w.en||'').replace(/"/g,'""')}","${(w.example_en||'').replace(/"/g,'""')}","${(w.example_cn||'').replace(/"/g,'""')}"`);const csv='中文,英文,例句(EN),例句(CN)\n'+rows.join('\n');const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='ged_a3b1.csv';a.click();showBottom('已导出 CSV');};document.getElementById('btnFlash').onclick=()=>{if(list.length===0){showBottom('词库为空');return;}let idx=Math.floor(Math.random()*list.length);const w=list[idx];document.getElementById('playArea').innerHTML=`<div class="card"><h2>${escapeHtml(w.en)}</h2><p>${escapeHtml(w.cn)}</p><p class="small">例：${escapeHtml(w.example_en)}</p><p class="small">中：${escapeHtml(w.example_cn)}</p></div>`;};document.getElementById('btnQuizCE').onclick=()=>{if(list.length===0){showBottom('词库为空');return;}let pool=list.slice();pool.sort(()=>Math.random()-0.5);let q=0,score=0;const area=document.getElementById('playArea');area.innerHTML='';const ask=()=>{if(q>=pool.length){area.innerHTML=`<div class="small">完成！得分 ${score}/${pool.length}</div>`;return;}const w=pool[q];area.innerHTML=`<div class="card"><div class="small">中文：${escapeHtml(w.cn)}</div><input id="answer" class="controls"/><button id="check" class="btn">提交</button><div id="result" class="small"></div></div>`;document.getElementById('check').onclick=()=>{const a=document.getElementById('answer').value.trim().toLowerCase();if(a===(w.en||'').toLowerCase()){score++;w.correct=(w.correct||0)+1;saveProgress();showBottom('回答正确');}else{w.wrong=(w.wrong||0)+1;saveProgress();showBottom('回答错误 — 正确答案：'+w.en);}q++;ask();};};document.getElementById('btnQuizEC').onclick=()=>{if(list.length===0){showBottom('词库为空');return;}let pool=list.slice();pool.sort(()=>Math.random()-0.5);let q=0,score=0;const area=document.getElementById('playArea');area.innerHTML='';const ask=()=>{if(q>=pool.length){area.innerHTML=`<div class="small">完成！得分 ${score}/${pool.length}</div>`;return;}const w=pool[q];area.innerHTML=`<div class="card"><div class="small">英文：${escapeHtml(w.en)}</div><input id="answer" class="controls"/><button id="check" class="btn">提交</button><div id="result" class="small"></div></div>`;document.getElementById('check').onclick=()=>{const a=document.getElementById('answer').value.trim();if(a===(w.cn||'')){score++;w.correct=(w.correct||0)+1;saveProgress();showBottom('回答正确');}else{w.wrong=(w.wrong||0)+1;saveProgress();showBottom('回答错误 — 正确答案：'+w.cn);}q++;ask();};};function saveProgress(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(list));}catch(e){}};load();